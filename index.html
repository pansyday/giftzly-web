<!DOCTYPE html>
<html lang="fr" class="scroll-smooth">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>Giftzly ‚Äì Liste de cadeaux</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Tailwind config -->
  <script>
    tailwind.config = {
      darkMode: 'media',
      theme: {
        extend: {
          colors: { giftTeal: "#009C9B" }
        }
      }
    }
  </script>

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="assets/favicon.png" />

  <!-- Meta -->
  <meta name="theme-color" content="#009C9B">
  <meta name="description" content="Consultez et r√©servez un cadeau dans une liste partag√©e Giftzly.">

  <style>
    body { background: #F7F8FA; }
    @media (prefers-color-scheme: dark) {
      body { background: #111418; }
    }
    .fade-in { animation: fadeIn .4s ease-out forwards; opacity: 0; }
    @keyframes fadeIn { to { opacity: 1; } }
  </style>
</head>

<body class="text-gray-800 dark:text-gray-200">

  <!-- HEADER -->
  <header class="w-full bg-white dark:bg-gray-900 shadow-sm py-3 px-6 flex items-center gap-3">

    <!-- Logo adaptatif -->
    <picture>
      <source srcset="assets/logo-dark.png" media="(prefers-color-scheme: dark)">
      <img src="assets/logo-light.png" alt="Giftzly"
           class="w-10 h-10 rounded-xl object-cover" />
    </picture>

    <h1 class="text-2xl font-bold tracking-tight text-teal-700 dark:text-teal-300">
      Giftzly
    </h1>
  </header>

  <!-- Spacer -->
  <div class="h-6"></div>


  <!-- CONTENT WRAPPER -->
  <div id="app" class="max-w-4xl mx-auto px-4 pb-20">

    <!-- LOADING -->
    <div id="loading" class="text-center py-20">
      <div class="animate-spin h-12 w-12 border-4 border-teal-500 border-t-transparent rounded-full mx-auto"></div>
      <p class="mt-4 text-gray-500 dark:text-gray-400">Chargement de la liste‚Ä¶</p>
    </div>

    <!-- CONTENT -->
    <div id="content" class="hidden fade-in">

      <!-- APP LINK -->
      <div class="mb-4 flex justify-end">
        <a id="open-app-btn" href="#"
           class="text-sm text-teal-700 dark:text-teal-400 underline hover:text-teal-900 dark:hover:text-teal-300">
          üì± Ouvrir dans l‚Äôapplication Giftzly
        </a>
      </div>

      <!-- HERO -->
      <div class="relative h-64 rounded-2xl overflow-hidden shadow-md">
        <img id="cover" class="absolute inset-0 w-full h-full object-cover" />
        <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-black/20 to-transparent"></div>

        <div class="absolute bottom-4 left-4">
          <h2 id="title" class="text-3xl font-bold text-white drop-shadow"></h2>
          <p id="description" class="text-white/90 text-sm mt-1 max-w-md"></p>
        </div>
      </div>

      <!-- OWNER -->
      <p id="owner" class="mt-4 text-sm text-gray-600 dark:text-gray-400"></p>

      <!-- ITEMS -->
      <h3 class="text-2xl font-semibold mt-8 mb-3 text-teal-700 dark:text-teal-300">Cadeaux</h3>

      <div id="items-container" class="space-y-4"></div>

    </div>
  </div>


  <!-- POPUP R√âSERVATION -->
  <div id="popup" class="hidden fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-50">
    <div class="bg-white dark:bg-gray-800 w-80 rounded-xl p-6 shadow-xl fade-in">

      <h3 class="text-lg font-bold text-teal-700 dark:text-teal-300 mb-4">R√©server ce cadeau</h3>

      <input id="popup-name" type="text" placeholder="Votre pr√©nom"
             class="w-full border border-gray-300 dark:border-gray-700 rounded-lg px-3 py-2 mb-3 
                    bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200">

      <input id="popup-email" type="email" placeholder="Votre email"
             class="w-full border border-gray-300 dark:border-gray-700 rounded-lg px-3 py-2 mb-4 
                    bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200">

      <button id="popup-confirm"
        class="w-full bg-teal-600 text-white py-2 rounded-lg font-semibold shadow hover:bg-teal-700 transition">
        R√©server
      </button>

      <button id="popup-close"
        class="w-full text-gray-500 mt-3">
        Annuler
      </button>
    </div>
  </div>


  <!-- SCRIPT -->
  <script>

    /* -----------------------------
       CONSTANTES
    ------------------------------ */
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get("token") || urlParams.get("t");

    const PUBLIC_LIST_URL =
      "https://wboqgmorfyqfhzonbvkm.supabase.co/functions/v1/public-list?token=";

    const RESERVE_URL =
      "https://wboqgmorfyqfhzonbvkm.supabase.co/functions/v1/reserve-item";

    const CANCEL_URL =
      "https://wboqgmorfyqfhzonbvkm.supabase.co/functions/v1/cancel-reservation";

    const APP_DEEPLINK = "giftzly://list/" + token;
    const APP_STORE_URL = "https://apps.apple.com/app/id0000000000"; // ‚Üê Mets ton App Store ID ici


    /* -----------------------------
       DOM ELEMENTS
    ------------------------------ */
    const loadingEl = document.getElementById("loading");
    const contentEl = document.getElementById("content");

    const coverEl = document.getElementById("cover");
    const titleEl = document.getElementById("title");
    const descEl = document.getElementById("description");
    const ownerEl = document.getElementById("owner");

    const itemsContainer = document.getElementById("items-container");

    const popup = document.getElementById("popup");
    const popupName = document.getElementById("popup-name");
    const popupEmail = document.getElementById("popup-email");
    const popupConfirmBtn = document.getElementById("popup-confirm");
    const popupCloseBtn = document.getElementById("popup-close");

    let currentItemId = null;


    /* -----------------------------
       DEEP LINK APP
    ------------------------------ */
    document.getElementById("open-app-btn").onclick = (e) => {
      e.preventDefault();
      window.location.href = APP_DEEPLINK;
      setTimeout(() => { window.location.href = APP_STORE_URL; }, 900);
    };


    /* -----------------------------
       CHARGEMENT LISTE
    ------------------------------ */
    async function loadList() {
      const res = await fetch(PUBLIC_LIST_URL + token);
      const data = await res.json();

      if (data.error) {
        loadingEl.innerHTML = `<p class='text-red-500'>${data.error}</p>`;
        return;
      }

      loadingEl.classList.add("hidden");
      contentEl.classList.remove("hidden");

      // HERO
      titleEl.textContent = data.list.title;
      descEl.textContent = data.list.description || "";
      coverEl.src = data.list.cover_url;

      // OWNER
      ownerEl.textContent = "Liste cr√©√©e par " + (data.list.owner_name || "l‚Äôauteur");

      // ITEMS
      itemsContainer.innerHTML = "";

      data.items.forEach(item => {
        const card = document.createElement("div");
        card.className =
          "bg-white dark:bg-gray-800 rounded-xl shadow p-4 flex fade-in";

        const reservedText =
          item.is_reserved
            ? `
      <span class="text-red-600 dark:text-red-400 font-semibold">
        D√©j√† r√©serv√© ${
          item.guest_name
            ? `par ${item.guest_name}`
            : item.reserved_by_name
              ? `par ${item.reserved_by_name}`
              : ""
        }
      </span>

      ${
        item.guest_email
          ? `<button data-cancel-id="${item.id}"
                     class="cancel-btn text-sm text-red-700 dark:text-red-400 underline ml-1">
                Annuler
             </button>`
          : ""
      }
      `
            : `<button data-id="${item.id}"
                 class="reserve-btn bg-teal-600 text-white px-4 py-2 rounded-lg font-medium shadow hover:bg-teal-700 transition">
                 R√©server
               </button>`;

        card.innerHTML = `
          <img src="${item.image_url}" class="w-24 h-24 rounded-lg object-cover mr-4">

          <div class="flex-1">
            <h4 class="font-semibold text-lg">${item.title}</h4>

            <p class="text-gray-600 dark:text-gray-400 text-sm mb-1">
              ${item.description || ""}
            </p>

            <p class="text-teal-700 dark:text-teal-400 font-semibold mb-1">
              ${item.price ? item.price + " ‚Ç¨" : ""}
            </p>

            ${
              item.url
                ? `<a href="${item.url}" target="_blank"
                     class="text-sm text-teal-700 dark:text-teal-400 underline">
                     Voir le site
                   </a>`
                : ""
            }

            <div class="mt-2">
              ${reservedText}
            </div>
          </div>
        `;

        itemsContainer.appendChild(card);
      });
    }


    /* -----------------------------
       EVENT DELEGATION
       (R√âSERVER + ANNULER)
    ------------------------------ */
    document.addEventListener("click", (e) => {
      const t = e.target;

      // --- R√âSERVER ---
      if (t.matches(".reserve-btn")) {
        currentItemId = t.dataset.id;
        popup.classList.remove("hidden");
        return;
      }

      // --- ANNULER R√âSERVATION ---
      if (t.matches(".cancel-btn")) {
        const email = prompt("Entrez l‚Äôemail utilis√© pour r√©server :");
        if (!email) return;

        fetch(CANCEL_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            token,
            item_id: t.dataset.cancelId,
            email
          })
        })
        .then(r => r.json())
        .then(resp => {
          if (resp.success) {
            alert("R√©servation annul√©e !");
            loadList();
          } else {
            alert(resp.error || "Erreur.");
          }
        });
      }
    });


    /* -----------------------------
       POPUP CONFIRMATION
    ------------------------------ */
    popupCloseBtn.onclick = () => {
      popup.classList.add("hidden");
      popupName.value = "";
      popupEmail.value = "";
    };

    popupConfirmBtn.onclick = async () => {
      const name = popupName.value.trim();
      const email = popupEmail.value.trim();

      if (!name || !email) {
        alert("Veuillez entrer votre pr√©nom et votre email.");
        return;
      }

      const payload = { token, item_id: currentItemId, name, email };

      const res = await fetch(RESERVE_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const data = await res.json();

      if (data.success) {
        alert("R√©servation confirm√©e !");
        popup.classList.add("hidden");
        loadList();
      } else {
        alert(data.error || "Erreur lors de la r√©servation.");
      }
    };


    /* -----------------------------
       START
    ------------------------------ */
    loadList();

  </script>

</body>
</html>

<!-- force redeploy -->

